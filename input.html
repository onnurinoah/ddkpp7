<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ì´ëŠ”ë¼ë””ì˜¤ ì‹œì²­ì ì°¸ì—¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA4f6lYwTUK8PxjnKb-jEXOXwWgj0KJdxo",
            authDomain: "ddkpp7.firebaseapp.com",
            projectId: "ddkpp7",
            storageBucket: "ddkpp7.firebasestorage.app",
            messagingSenderId: "710654878188",
            appId: "1:710654878188:web:125f72d75677dc8ac820c9",
            measurementId: "G-ZLJVX995JC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 1. íˆ¬í‘œ í•¨ìˆ˜ (10ì´ˆ ì œí•œ)
        window.vote = (type) => {
            const now = Date.now();
            const lastVoteTime = localStorage.getItem('last_vote_timestamp');
            const COOLDOWN_MS = 10000;

            if (lastVoteTime && (now - lastVoteTime < COOLDOWN_MS)) {
                const remaining = Math.ceil((COOLDOWN_MS - (now - lastVoteTime)) / 1000);
                alert(`ì—°ì†ìœ¼ë¡œ íˆ¬í‘œí•˜ì‹¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤! (${remaining}ì´ˆ ë‚¨ìŒ)`);
                return;
            }

            const voteRef = ref(db, `votes/${type}`);
            onValue(voteRef, (snapshot) => {
                const current = snapshot.val() || 0;
                set(ref(db, `votes/${type}`), current + 1);
            }, { onlyOnce: true });

            localStorage.setItem('last_vote_timestamp', now);
            alert(`${type.toUpperCase()}ì— íˆ¬í‘œ ì™„ë£Œ!`);
        };

        // 2. ëŒ“ê¸€ ë“±ë¡ í•¨ìˆ˜
        window.submitComment = () => {
            const nickname = document.getElementById('nickname').value;
            const text = document.getElementById('comment-input').value;
            if(!nickname || !text) return alert("ë‹‰ë„¤ì„ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            
            push(ref(db, 'comments'), { 
                nickname, 
                text, 
                timestamp: Date.now() 
            });
            document.getElementById('comment-input').value = '';
        };

        // 3. ì‹¤ì‹œê°„ íˆ¬í‘œ í˜„í™© ì—…ë°ì´íŠ¸
        onValue(ref(db, 'votes'), (snapshot) => {
            const data = snapshot.val() || { o: 0, x: 0 };
            const total = (data.o || 0) + (data.x || 0);
            const oPercent = total === 0 ? 50 : Math.round((data.o / total) * 100);
            const xPercent = total === 0 ? 50 : 100 - oPercent;

            document.getElementById('o-count').innerText = data.o || 0;
            document.getElementById('x-count').innerText = data.x || 0;
            document.getElementById('o-bar').style.width = oPercent + '%';
            document.getElementById('x-bar').style.width = xPercent + '%';
            document.getElementById('o-label').innerText = oPercent + '%';
            document.getElementById('x-label').innerText = xPercent + '%';
        });

        // 4. ì‹¤ì‹œê°„ ëŒ“ê¸€ ëª©ë¡ (ìµœì‹  5ê°œ ì œí•œ)
        const commentsRef = query(ref(db, 'comments'), limitToLast(5));
        onValue(commentsRef, (snapshot) => {
            const listArea = document.getElementById('comment-list');
            listArea.innerHTML = '';
            const data = snapshot.val();
            if (data) {
                Object.values(data).reverse().forEach(comment => {
                    const item = document.createElement('div');
                    item.className = "p-3 bg-white rounded-lg border border-gray-100 shadow-sm mb-2";
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-xs text-blue-600">${comment.nickname}</span>
                            <span class="text-[9px] text-gray-400">${new Date(comment.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-sm text-gray-800 leading-tight">${comment.text}</p>
                    `;
                    listArea.appendChild(item);
                });
            } else {
                listArea.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>';
            }
        });
    </script>
</head>
<body class="bg-gray-50 flex justify-center min-h-screen">
    <div class="w-full max-w-md bg-white min-h-screen shadow-2xl flex flex-col border-x border-gray-200">
        
        <div class="p-5 pt-8">
            <h1 class="text-center text-lg font-black text-gray-800 mb-4">ğŸ“» LIVE ë¼ë””ì˜¤ ì°¸ì—¬</h1>
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 shadow-inner">
                <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-2 px-1">
                    <span>O íˆ¬í‘œí˜„í™©</span>
                    <span>X íˆ¬í‘œí˜„í™©</span>
                </div>
                <div class="flex h-10 w-full rounded-xl overflow-hidden shadow-md">
                    <div id="o-bar" class="bg-blue-500 flex items-center justify-center text-white text-sm font-black transition-all duration-700" style="width: 50%">
                        <span id="o-label">50%</span>
                    </div>
                    <div id="x-bar" class="bg-red-500 flex items-center justify-center text-white text-sm font-black transition-all duration-700" style="width: 50%">
                        <span id="x-label">50%</span>
                    </div>
                </div>
                <div class="flex justify-between mt-2 px-2">
                    <span class="text-blue-700 font-bold text-sm"><span id="o-count">0</span>í‘œ</span>
                    <span class="text-red-700 font-bold text-sm"><span id="x-count">0</span>í‘œ</span>
                </div>
            </div>
        </div>

        <div class="px-5 mb-6">
            <div class="flex gap-4">
                <button onclick="vote('o')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-5 rounded-2xl text-4xl font-black shadow-lg active:scale-95 transition-all">O</button>
                <button onclick="vote('x')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-5 rounded-2xl text-4xl font-black shadow-lg active:scale-95 transition-all">X</button>
            </div>
            <p class="text-center text-[10px] text-gray-400 mt-2">* íˆ¬í‘œëŠ” 10ì´ˆì— í•œ ë²ˆë§Œ ì°¸ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="px-5 mb-8">
            <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200 space-y-2">
                <input id="nickname" type="text" placeholder="ë‹‰ë„¤ì„" 
                       class="w-full border border-gray-300 p-2.5 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-sm">
                <textarea id="comment-input" rows="2" placeholder="ì‚¬ì—°ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!" 
                          class="w-full border border-gray-300 p-2.5 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-sm"></textarea>
                <button onclick="submitComment()" 
                        class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-black active:scale-95 transition">ëŒ“ê¸€ ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>

        <div class="flex-1 px-5 pb-10 overflow-hidden">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xs font-bold text-gray-600 flex items-center">
                    <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-2"></span>
                    ìµœì‹  ëŒ“ê¸€ (5ê°œ)
                </h2>
            </div>
            <div id="comment-list" class="space-y-3">
                </div>
        </div>
    </div>
</body>
</html>
